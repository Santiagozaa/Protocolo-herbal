<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Pacientes - Tratamiento Herbal</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f5f5f5; color: #333; line-height: 1.6; min-height: 100vh; }
        
        /* LOGIN */
        .login-screen { min-height: 100vh; display: flex; justify-content: center; align-items: center; background: linear-gradient(135deg, #1a472a 0%, #2e7d32 50%, #4caf50 100%); padding: 20px; }
        .login-container { background: white; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 100%; max-width: 420px; overflow: hidden; }
        .login-header { background: linear-gradient(135deg, #2e7d32, #4caf50); color: white; padding: 40px 30px; text-align: center; }
        .login-header .logo { font-size: 50px; margin-bottom: 15px; }
        .login-header h1 { font-size: 24px; margin-bottom: 5px; }
        .login-header p { opacity: 0.9; font-size: 14px; }
        .login-body { padding: 40px 30px; }
        .login-tipo { display: flex; gap: 10px; margin-bottom: 25px; }
        .login-tipo-btn { flex: 1; padding: 12px; border: 2px solid #e0e0e0; background: white; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; color: #666; }
        .login-tipo-btn:hover { border-color: #4caf50; color: #4caf50; }
        .login-tipo-btn.activo { border-color: #4caf50; background: #e8f5e9; color: #2e7d32; }
        .login-form .campo { margin-bottom: 20px; }
        .login-form label { display: block; font-weight: 600; margin-bottom: 8px; color: #555; font-size: 14px; }
        .login-form input { width: 100%; padding: 14px 16px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; transition: border-color 0.3s; }
        .login-form input:focus { outline: none; border-color: #4caf50; }
        .btn-login { width: 100%; padding: 16px; background: linear-gradient(135deg, #2e7d32, #4caf50); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; margin-top: 10px; }
        .btn-login:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(76,175,80,0.4); }
        .btn-login:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        .login-error { background: #ffebee; color: #c62828; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; display: none; }
        .login-error.visible { display: block; }
        .login-info { margin-top: 25px; padding-top: 20px; border-top: 1px solid #eee; font-size: 13px; color: #888; text-align: center; }
        
        /* LOADING */
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); display: none; justify-content: center; align-items: center; z-index: 2000; flex-direction: column; gap: 20px; }
        .loading-overlay.visible { display: flex; }
        .spinner { width: 50px; height: 50px; border: 4px solid #e0e0e0; border-top-color: #4caf50; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: #555; font-size: 16px; }
        
        /* HEADER */
        .header { background: linear-gradient(135deg, #2e7d32, #4caf50); color: white; padding: 20px 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .header-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .header h1 { font-size: 24px; font-weight: 600; }
        .header p { font-size: 14px; opacity: 0.9; }
        .online-badge { background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 12px; display: inline-flex; align-items: center; gap: 6px; }
        .online-dot { width: 8px; height: 8px; background: #8bc34a; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .header-user { display: flex; align-items: center; gap: 15px; }
        .user-info { text-align: right; }
        .user-name { font-weight: 600; font-size: 14px; }
        .user-role { font-size: 12px; opacity: 0.8; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; }
        .btn-logout { background: rgba(255,255,255,0.2); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 14px; cursor: pointer; transition: all 0.3s; }
        .btn-logout:hover { background: rgba(255,255,255,0.3); }
        .btn-nuevo { background: white; color: #2e7d32; border: none; padding: 12px 25px; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; }
        .btn-nuevo:hover { background: #e8f5e9; transform: translateY(-2px); }
        
        /* CONTENIDO */
        .main-content { max-width: 1200px; margin: 0 auto; padding: 30px; }
        .barra-busqueda { background: white; padding: 20px; border-radius: 10px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .barra-busqueda input { flex: 1; min-width: 200px; padding: 12px 20px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; }
        .barra-busqueda input:focus { outline: none; border-color: #4caf50; }
        .estadisticas { display: flex; gap: 20px; flex-wrap: wrap; }
        .stat { text-align: center; padding: 10px 20px; background: #f5f5f5; border-radius: 8px; }
        .stat-numero { font-size: 24px; font-weight: 700; color: #2e7d32; }
        .stat-label { font-size: 12px; color: #666; }
        
        /* GRID PACIENTES */
        .pacientes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .paciente-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: all 0.3s; cursor: pointer; }
        .paciente-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .paciente-header { padding: 20px; background: linear-gradient(135deg, #37474f, #546e7a); color: white; position: relative; }
        .paciente-nombre { font-size: 18px; font-weight: 600; margin-bottom: 5px; }
        .paciente-fecha { font-size: 13px; opacity: 0.8; }
        .paciente-credenciales { position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 5px; font-size: 11px; cursor: pointer; }
        .paciente-credenciales:hover { background: rgba(255,255,255,0.3); }
        .paciente-body { padding: 20px; }
        .paciente-motivo { font-size: 14px; color: #666; margin-bottom: 15px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .paciente-progreso { margin-bottom: 15px; }
        .progreso-label { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 5px; }
        .progreso-barra { background: #e0e0e0; height: 8px; border-radius: 4px; overflow: hidden; }
        .progreso-fill { height: 100%; background: linear-gradient(90deg, #4caf50, #8bc34a); border-radius: 4px; transition: width 0.5s; }
        .paciente-fases { display: flex; gap: 8px; margin-bottom: 15px; }
        .fase-indicador { flex: 1; height: 6px; background: #e0e0e0; border-radius: 3px; }
        .fase-indicador.activa { background: #ffc107; }
        .fase-indicador.completada { background: #4caf50; }
        .paciente-acciones { display: flex; gap: 10px; padding-top: 15px; border-top: 1px solid #eee; }
        .btn-accion { flex: 1; padding: 10px; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.3s; }
        .btn-abrir { background: #e8f5e9; color: #2e7d32; }
        .btn-abrir:hover { background: #c8e6c9; }
        .btn-eliminar { background: #ffebee; color: #c62828; }
        .btn-eliminar:hover { background: #ffcdd2; }
        
        /* ESTADO VACIO */
        .estado-vacio { text-align: center; padding: 60px 20px; background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .estado-vacio-icono { font-size: 64px; margin-bottom: 20px; }
        .estado-vacio h2 { color: #555; margin-bottom: 10px; }
        .estado-vacio p { color: #888; margin-bottom: 25px; }
        
        /* MODALES */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; padding: 20px; }
        .modal-overlay.visible { display: flex; }
        .modal { background: white; border-radius: 12px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .modal-header { padding: 20px 25px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 20px; color: #333; }
        .modal-close { background: none; border: none; font-size: 28px; cursor: pointer; color: #888; line-height: 1; }
        .modal-close:hover { color: #333; }
        .modal-body { padding: 25px; }
        .form-grupo { margin-bottom: 20px; }
        .form-grupo label { display: block; font-weight: 600; margin-bottom: 8px; color: #555; }
        .form-grupo input, .form-grupo textarea { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; font-family: inherit; }
        .form-grupo input:focus, .form-grupo textarea:focus { outline: none; border-color: #4caf50; }
        .credenciales-box { background: #fff8e1; border: 1px solid #ffca28; border-radius: 8px; padding: 15px; margin-top: 15px; }
        .credenciales-box h4 { color: #f57c00; margin-bottom: 10px; font-size: 14px; }
        .credenciales-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #ffe082; font-size: 14px; }
        .credenciales-item:last-child { border-bottom: none; }
        .credenciales-item strong { color: #555; }
        .credenciales-item span { font-family: monospace; background: #fff; padding: 2px 8px; border-radius: 4px; }
        .modal-footer { padding: 20px 25px; border-top: 1px solid #eee; display: flex; gap: 10px; justify-content: flex-end; }
        .btn-modal { padding: 12px 25px; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-cancelar { background: #f5f5f5; color: #666; }
        .btn-cancelar:hover { background: #e0e0e0; }
        .btn-guardar { background: #4caf50; color: white; }
        .btn-guardar:hover { background: #388e3c; }
        .btn-guardar:disabled { background: #ccc; cursor: not-allowed; }
        
        /* VISTA PLAN */
        .vista-plan { display: none; }
        .vista-plan.visible { display: block; }
        .vista-lista { display: block; }
        .vista-lista.oculta { display: none; }
        .app-container { display: none; }
        .app-container.visible { display: block; }
        .btn-volver { background: #f5f5f5; color: #555; border: none; padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
        .btn-volver:hover { background: #e0e0e0; }
        
        /* MODO LECTURA */
        .modo-lectura .btn-agregar, .modo-lectura .btn-eliminar-small, .modo-lectura .btn-eliminar, .modo-lectura .botones-plan, .modo-lectura .paciente-acciones { display: none !important; }
        .modo-lectura input, .modo-lectura textarea { background: #f9f9f9; border-color: #eee; pointer-events: none; }
        .modo-lectura .progreso-item { pointer-events: none; }
        .badge-lectura { background: #ff9800; color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: 600; margin-left: 15px; }
        
        /* TOAST */
        .mensaje-toast { position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); opacity: 0; transform: translateY(20px); transition: all 0.3s; z-index: 1001; }
        .mensaje-toast.visible { opacity: 1; transform: translateY(0); }
        .mensaje-toast.exito { background: #4caf50; }
        .mensaje-toast.error { background: #f44336; }
        
        /* PLAN */
        .plan-container { max-width: 900px; margin: 0 auto; }
        .plan-header { text-align: center; padding: 30px 20px; background: linear-gradient(135deg, #2e7d32, #4caf50); color: white; border-radius: 10px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .plan-header h1 { font-size: 28px; margin-bottom: 8px; font-weight: 600; }
        .plan-header p { font-size: 16px; opacity: 0.9; }
        .datos-paciente { background: white; padding: 25px; border-radius: 10px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .datos-paciente h2 { font-size: 18px; color: #555; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e0e0e0; }
        .campo { margin-bottom: 15px; }
        .campo label { display: block; font-weight: 600; color: #555; margin-bottom: 5px; font-size: 14px; }
        .campo input, .campo textarea { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 15px; transition: border-color 0.3s; }
        .campo input:focus, .campo textarea:focus { outline: none; border-color: #4caf50; }
        .progreso-section { background: white; padding: 20px; border-radius: 10px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .progreso-section h3 { text-align: center; color: #555; margin-bottom: 20px; font-size: 16px; }
        .progreso-barra-main { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .progreso-item { flex: 1; min-width: 120px; text-align: center; padding: 15px 10px; background: #f0f0f0; border-radius: 8px; cursor: pointer; transition: all 0.3s; border: 2px solid transparent; }
        .progreso-item:hover { background: #e8f5e9; }
        .progreso-item.completado { background: #4caf50; color: white; border-color: #2e7d32; }
        .progreso-item span { display: block; font-size: 13px; font-weight: 600; }
        .progreso-item .porcentaje-mini { font-size: 11px; margin-top: 4px; opacity: 0.8; }
        .flecha { color: #ccc; font-size: 20px; }
        
        /* ACORDEONES */
        .acordeon { margin-bottom: 15px; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .acordeon-header { background: #6d4c41; color: white; padding: 18px 25px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.3s; }
        .acordeon-header:hover { filter: brightness(1.1); }
        .acordeon-header-left { display: flex; align-items: center; gap: 15px; }
        .acordeon-header h3 { font-size: 18px; font-weight: 600; }
        .porcentaje-badge { background: rgba(255,255,255,0.25); padding: 5px 12px; border-radius: 20px; font-size: 14px; font-weight: 600; }
        .porcentaje-badge.en-progreso { background: rgba(255,193,7,0.9); color: #333; }
        .porcentaje-badge.completado { background: rgba(76,175,80,0.9); color: white; }
        .porcentaje-badge.no-iniciado { background: rgba(255,255,255,0.2); color: rgba(255,255,255,0.8); }
        .acordeon-header .icono { font-size: 24px; transition: transform 0.3s; font-weight: 300; }
        .acordeon.abierto .acordeon-header .icono { transform: rotate(45deg); }
        .acordeon-contenido { background: white; max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; }
        .acordeon.abierto .acordeon-contenido { max-height: 3000px; }
        .acordeon-inner { padding: 25px; }
        .progreso-visual { background: #e0e0e0; height: 8px; border-radius: 4px; margin-bottom: 20px; overflow: hidden; }
        .progreso-visual-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; background: linear-gradient(90deg, #4caf50, #8bc34a); }
        .progreso-info { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; color: #666; }
        .fase-info { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .fase-info > div { background: #f9f9f9; padding: 12px 15px; border-radius: 6px; }
        .fase-info label { font-size: 12px; color: #888; display: block; margin-bottom: 3px; }
        .fase-info input { border: none; background: transparent; width: 100%; padding: 0; font-size: 15px; font-weight: 500; }
        .objetivo { background: #f5f5f5; padding: 15px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #6d4c41; }
        .objetivo strong { color: #555; display: block; margin-bottom: 8px; }
        .objetivo textarea { width: 100%; border: 1px solid #ddd; border-radius: 4px; padding: 10px; font-size: 14px; resize: vertical; min-height: 50px; font-family: inherit; }
        .hierbas-titulo { font-size: 16px; font-weight: 600; color: #555; margin-bottom: 15px; }
        .hierbas-container { margin-bottom: 15px; }
        .hierba-row { display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 10px; margin-bottom: 12px; align-items: center; }
        .hierba-row input { padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .btn-eliminar-small { background: #ffebee; color: #c62828; border: none; border-radius: 6px; width: 36px; height: 36px; cursor: pointer; font-size: 18px; transition: background 0.3s; }
        .btn-eliminar-small:hover { background: #ffcdd2; }
        .btn-agregar { background: #e8f5e9; color: #2e7d32; border: 2px dashed #4caf50; border-radius: 6px; padding: 12px 20px; cursor: pointer; font-size: 14px; font-weight: 600; width: 100%; transition: all 0.3s; margin-top: 10px; }
        .btn-agregar:hover { background: #c8e6c9; }
        .seccion-extra { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        .seccion-extra label { font-weight: 600; color: #555; display: block; margin-bottom: 8px; font-size: 14px; }
        .seccion-extra textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; resize: vertical; min-height: 60px; font-family: inherit; }
        
        /* COLORES FASES */
        .fase-1 .acordeon-header { background: #6d4c41; }
        .fase-1 .objetivo { border-left-color: #6d4c41; }
        .fase-1 .progreso-visual-fill { background: linear-gradient(90deg, #6d4c41, #8d6e63); }
        .fase-2 .acordeon-header { background: #558b2f; }
        .fase-2 .objetivo { border-left-color: #558b2f; }
        .fase-2 .progreso-visual-fill { background: linear-gradient(90deg, #558b2f, #7cb342); }
        .fase-3 .acordeon-header { background: #37474f; }
        .fase-3 .objetivo { border-left-color: #37474f; }
        .fase-3 .progreso-visual-fill { background: linear-gradient(90deg, #37474f, #546e7a); }
        .fase-4 .acordeon-header { background: #5d4037; }
        .fase-4 .objetivo { border-left-color: #5d4037; }
        .fase-4 .progreso-visual-fill { background: linear-gradient(90deg, #5d4037, #795548); }
        
        .recomendaciones { background: white; padding: 25px; border-radius: 10px; margin-top: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .recomendaciones h3 { font-size: 18px; color: #555; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e0e0e0; }
        .recomendaciones-container { margin-bottom: 15px; }
        .recomendacion-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .recomendacion-row input { flex: 1; padding: 12px 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .recomendacion-bullet { color: #4caf50; font-size: 20px; font-weight: bold; }
        .contacto { background: white; padding: 25px; border-radius: 10px; margin-top: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .contacto h3 { grid-column: 1 / -1; font-size: 18px; color: #555; margin-bottom: 5px; padding-bottom: 10px; border-bottom: 2px solid #e0e0e0; }
        .botones-plan { display: flex; gap: 15px; justify-content: center; margin-top: 30px; flex-wrap: wrap; }
        .btn-plan { padding: 15px 30px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-imprimir { background: #4caf50; color: white; }
        .btn-imprimir:hover { background: #388e3c; }
        .btn-guardar-plan { background: #1976d2; color: white; }
        .btn-guardar-plan:hover { background: #1565c0; }
        
        @media print {
            .header, .btn-volver, .botones-plan, .btn-agregar, .btn-eliminar-small, .login-screen { display: none !important; }
            .acordeon-contenido { max-height: none !important; }
            .app-container { display: block !important; }
        }
        
        @media (max-width: 600px) {
            .header-content { flex-direction: column; text-align: center; }
            .fase-info, .contacto { grid-template-columns: 1fr; }
            .hierba-row { grid-template-columns: 1fr; }
            .progreso-barra-main { flex-direction: column; }
            .flecha { transform: rotate(90deg); }
            .login-tipo { flex-direction: column; }
        }
    </style>
</head>
<body>
    <!-- LOADING -->
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Cargando...</div>
    </div>
    
    <!-- LOGIN -->
    <div class="login-screen" id="login-screen">
        <div class="login-container">
            <div class="login-header">
                <div class="logo">üåø</div>
                <h1>Portal de Tratamiento Herbal</h1>
                <p>Inicie sesi√≥n para continuar</p>
            </div>
            <div class="login-body">
                <div class="login-tipo">
                    <button class="login-tipo-btn activo" onclick="cambiarTipoLogin('admin')" id="btn-tipo-admin">üë®‚Äç‚öïÔ∏è Administrador</button>
                    <button class="login-tipo-btn" onclick="cambiarTipoLogin('paciente')" id="btn-tipo-paciente">üë§ Paciente</button>
                </div>
                <div class="login-error" id="login-error">Usuario o contrase√±a incorrectos</div>
                <form class="login-form" onsubmit="intentarLogin(event)">
                    <div class="campo">
                        <label>Usuario</label>
                        <input type="text" id="login-usuario" placeholder="Ingrese su usuario" required>
                    </div>
                    <div class="campo">
                        <label>Contrase√±a</label>
                        <input type="password" id="login-password" placeholder="Ingrese su contrase√±a" required>
                    </div>
                    <button type="submit" class="btn-login" id="btn-login-submit">Iniciar Sesi√≥n</button>
                </form>
                <div class="login-info" id="login-info-admin"><strong>Primera vez?</strong> Usa: <code>admin</code> / <code>admin123</code></div>
                <div class="login-info" id="login-info-paciente" style="display: none;">Ingrese las credenciales proporcionadas por su profesional</div>
            </div>
        </div>
    </div>
    
    <!-- APP -->
    <div class="app-container" id="app-container">
        <div class="header">
            <div class="header-content">
                <div>
                    <h1>üåø Portal de Pacientes</h1>
                    <p>Gesti√≥n de Tratamientos Herbales <span class="online-badge"><span class="online-dot"></span> Online</span></p>
                </div>
                <div class="header-user">
                    <div class="user-info">
                        <div class="user-name" id="header-user-name">Admin</div>
                        <div class="user-role" id="header-user-role">Administrador</div>
                    </div>
                    <button class="btn-nuevo" onclick="abrirModalNuevo()" id="btn-nuevo-paciente"><span>+</span> Nuevo Paciente</button>
                    <button class="btn-logout" onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
                </div>
            </div>
        </div>
        
        <div class="vista-lista" id="vista-lista">
            <div class="main-content">
                <div class="barra-busqueda" id="barra-busqueda">
                    <input type="text" id="busqueda" placeholder="Buscar paciente..." oninput="filtrarPacientes()">
                    <div class="estadisticas">
                        <div class="stat"><div class="stat-numero" id="total-pacientes">0</div><div class="stat-label">Pacientes</div></div>
                        <div class="stat"><div class="stat-numero" id="en-tratamiento">0</div><div class="stat-label">En tratamiento</div></div>
                    </div>
                </div>
                <div class="pacientes-grid" id="pacientes-grid"></div>
                <div class="estado-vacio" id="estado-vacio" style="display: none;">
                    <div class="estado-vacio-icono">üìã</div>
                    <h2>No hay pacientes registrados</h2>
                    <p>Comienza agregando tu primer paciente</p>
                    <button class="btn-nuevo" onclick="abrirModalNuevo()"><span>+</span> Agregar Paciente</button>
                </div>
            </div>
        </div>
        
        <div class="vista-plan" id="vista-plan">
            <div class="main-content">
                <button class="btn-volver" onclick="volverALista()" id="btn-volver">‚Üê Volver a la lista</button>
                <div class="plan-container" id="plan-container"></div>
            </div>
        </div>
    </div>
    
    <!-- MODALES -->
    <div class="modal-overlay" id="modal-nuevo">
        <div class="modal">
            <div class="modal-header"><h2>Nuevo Paciente</h2><button class="modal-close" onclick="cerrarModal()">&times;</button></div>
            <div class="modal-body">
                <div class="form-grupo"><label>Nombre completo *</label><input type="text" id="nuevo-nombre" placeholder="Ingrese el nombre"></div>
                <div class="form-grupo"><label>Fecha de inicio</label><input type="date" id="nuevo-fecha"></div>
                <div class="form-grupo"><label>Motivo de consulta</label><textarea id="nuevo-motivo" rows="3" placeholder="Describa el motivo"></textarea></div>
                <div class="credenciales-box">
                    <h4>üîê Credenciales de acceso para el paciente</h4>
                    <div class="form-grupo" style="margin-bottom: 10px;"><label style="font-size: 13px;">Usuario</label><input type="text" id="nuevo-usuario" placeholder="Ej: juan.perez"></div>
                    <div class="form-grupo" style="margin-bottom: 0;"><label style="font-size: 13px;">Contrase√±a</label><input type="text" id="nuevo-password" placeholder="M√≠nimo 6 caracteres"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-cancelar" onclick="cerrarModal()">Cancelar</button>
                <button class="btn-modal btn-guardar" onclick="crearPaciente()" id="btn-crear-paciente">Crear Paciente</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="modal-eliminar">
        <div class="modal">
            <div class="modal-header"><h2>Eliminar Paciente</h2><button class="modal-close" onclick="cerrarModalEliminar()">&times;</button></div>
            <div class="modal-body">
                <p>¬øEst√° seguro que desea eliminar a <strong id="nombre-eliminar"></strong>?</p>
                <p style="color: #888; margin-top: 10px;">Esta acci√≥n no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-cancelar" onclick="cerrarModalEliminar()">Cancelar</button>
                <button class="btn-modal btn-guardar" style="background: #f44336;" onclick="confirmarEliminar()">Eliminar</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="modal-credenciales">
        <div class="modal">
            <div class="modal-header"><h2>Credenciales del Paciente</h2><button class="modal-close" onclick="cerrarModalCredenciales()">&times;</button></div>
            <div class="modal-body">
                <p style="margin-bottom: 15px;">Comparta estas credenciales con el paciente:</p>
                <div class="credenciales-box">
                    <div class="credenciales-item"><strong>Usuario:</strong><span id="cred-usuario"></span></div>
                    <div class="credenciales-item"><strong>Contrase√±a:</strong><span id="cred-password"></span></div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn-modal btn-guardar" onclick="cerrarModalCredenciales()">Cerrar</button></div>
        </div>
    </div>
    
    <div class="mensaje-toast" id="mensaje-toast"></div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script>
        // ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
        // ‚ïë  üî• PEGA TUS CREDENCIALES DE FIREBASE AQU√ç ABAJO üî•            ‚ïë
        // ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
        
        const firebaseConfig = {
            apiKey: "PEGA-TU-API-KEY-AQUI",
            authDomain: "PEGA-TU-AUTH-DOMAIN-AQUI",
            projectId: "PEGA-TU-PROJECT-ID-AQUI",
            storageBucket: "PEGA-TU-STORAGE-BUCKET-AQUI",
            messagingSenderId: "PEGA-TU-MESSAGING-SENDER-ID-AQUI",
            appId: "PEGA-TU-APP-ID-AQUI"
        };
        
        // ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
        // ‚ïë  NO MODIFIQUES NADA DEBAJO DE ESTA L√çNEA                       ‚ïë
        // ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
        
        let db = null;
        let pacientes = [];
        let usuarioActual = null;
        let pacienteActual = null;
        let pacienteAEliminar = null;
        let tipoLoginActual = 'admin';
        
        const ADMIN_USER = 'admin';
        const ADMIN_PASS = 'admin123';
        
        // INIT
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                mostrarLoading('Conectando...');
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                await db.collection('config').doc('test').set({ ok: true });
                ocultarLoading();
                verificarSesion();
            } catch (error) {
                ocultarLoading();
                alert('Error de conexi√≥n con Firebase. Verifica las credenciales en el c√≥digo.');
                console.error(error);
            }
        });
        
        function verificarSesion() {
            const sesion = localStorage.getItem('sesionActual');
            if (sesion) {
                usuarioActual = JSON.parse(sesion);
                mostrarApp();
            } else {
                document.getElementById('login-screen').style.display = 'flex';
            }
        }
        
        function mostrarLoading(t = 'Cargando...') {
            document.getElementById('loading').classList.add('visible');
            document.querySelector('.loading-text').textContent = t;
        }
        
        function ocultarLoading() {
            document.getElementById('loading').classList.remove('visible');
        }
        
        function cambiarTipoLogin(tipo) {
            tipoLoginActual = tipo;
            document.getElementById('btn-tipo-admin').classList.toggle('activo', tipo === 'admin');
            document.getElementById('btn-tipo-paciente').classList.toggle('activo', tipo === 'paciente');
            document.getElementById('login-info-admin').style.display = tipo === 'admin' ? 'block' : 'none';
            document.getElementById('login-info-paciente').style.display = tipo === 'paciente' ? 'block' : 'none';
            document.getElementById('login-error').classList.remove('visible');
        }
        
        async function intentarLogin(e) {
            e.preventDefault();
            const usuario = document.getElementById('login-usuario').value.trim();
            const password = document.getElementById('login-password').value;
            document.getElementById('btn-login-submit').disabled = true;
            mostrarLoading('Verificando...');
            
            try {
                if (tipoLoginActual === 'admin') {
                    const adminDoc = await db.collection('config').doc('admin').get();
                    let adminData = adminDoc.exists ? adminDoc.data() : { usuario: ADMIN_USER, password: ADMIN_PASS };
                    if (!adminDoc.exists) await db.collection('config').doc('admin').set(adminData);
                    
                    if (usuario === adminData.usuario && password === adminData.password) {
                        usuarioActual = { tipo: 'admin', nombre: 'Administrador', usuario };
                        localStorage.setItem('sesionActual', JSON.stringify(usuarioActual));
                        ocultarLoading();
                        mostrarApp();
                        return;
                    }
                } else {
                    const snapshot = await db.collection('pacientes').where('credenciales.usuario', '==', usuario).where('credenciales.password', '==', password).get();
                    if (!snapshot.empty) {
                        const paciente = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
                        usuarioActual = { tipo: 'paciente', nombre: paciente.nombre, pacienteId: paciente.id };
                        localStorage.setItem('sesionActual', JSON.stringify(usuarioActual));
                        ocultarLoading();
                        mostrarApp();
                        return;
                    }
                }
                ocultarLoading();
                document.getElementById('login-error').classList.add('visible');
            } catch (error) {
                console.error(error);
                ocultarLoading();
                mostrarMensaje('Error de conexi√≥n', 'error');
            }
            document.getElementById('btn-login-submit').disabled = false;
        }
        
        function cerrarSesion() {
            usuarioActual = null;
            pacienteActual = null;
            localStorage.removeItem('sesionActual');
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('app-container').classList.remove('visible');
            document.getElementById('login-usuario').value = '';
            document.getElementById('login-password').value = '';
            document.getElementById('login-error').classList.remove('visible');
            document.getElementById('btn-login-submit').disabled = false;
        }
        
        async function mostrarApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-container').classList.add('visible');
            document.getElementById('header-user-name').textContent = usuarioActual.nombre;
            document.getElementById('header-user-role').textContent = usuarioActual.tipo === 'admin' ? 'Administrador' : 'Paciente';
            
            if (usuarioActual.tipo === 'admin') {
                document.getElementById('btn-nuevo-paciente').style.display = 'flex';
                document.getElementById('barra-busqueda').style.display = 'flex';
                document.getElementById('vista-lista').classList.remove('oculta');
                document.getElementById('vista-plan').classList.remove('visible');
                await cargarPacientes();
                renderizarLista();
            } else {
                document.getElementById('btn-nuevo-paciente').style.display = 'none';
                document.getElementById('barra-busqueda').style.display = 'none';
                document.getElementById('vista-lista').classList.add('oculta');
                document.getElementById('vista-plan').classList.add('visible');
                document.getElementById('btn-volver').style.display = 'none';
                mostrarLoading('Cargando tu plan...');
                const doc = await db.collection('pacientes').doc(usuarioActual.pacienteId).get();
                if (doc.exists) {
                    pacienteActual = { id: doc.id, ...doc.data() };
                    renderizarPlan(true);
                }
                ocultarLoading();
            }
        }
        
        async function cargarPacientes() {
            mostrarLoading('Cargando pacientes...');
            try {
                const snapshot = await db.collection('pacientes').orderBy('fechaCreacion', 'desc').get();
                pacientes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error(error);
                mostrarMensaje('Error al cargar', 'error');
            }
            ocultarLoading();
        }
        
        async function guardarPaciente(p) {
            try {
                if (p.id) await db.collection('pacientes').doc(p.id).set(p);
                else { const ref = await db.collection('pacientes').add(p); p.id = ref.id; }
                return true;
            } catch (error) {
                console.error(error);
                mostrarMensaje('Error al guardar', 'error');
                return false;
            }
        }
        
        async function eliminarPacienteDB(id) {
            try { await db.collection('pacientes').doc(id).delete(); return true; }
            catch (error) { console.error(error); mostrarMensaje('Error al eliminar', 'error'); return false; }
        }
        
        function mostrarMensaje(t, tipo = 'exito') {
            const toast = document.getElementById('mensaje-toast');
            toast.textContent = t;
            toast.className = 'mensaje-toast visible ' + tipo;
            setTimeout(() => toast.classList.remove('visible'), 3000);
        }
        
        function abrirModalNuevo() {
            document.getElementById('modal-nuevo').classList.add('visible');
            document.getElementById('nuevo-nombre').focus();
            document.getElementById('nuevo-fecha').value = new Date().toISOString().split('T')[0];
        }
        
        function cerrarModal() {
            document.getElementById('modal-nuevo').classList.remove('visible');
            document.getElementById('nuevo-nombre').value = '';
            document.getElementById('nuevo-fecha').value = '';
            document.getElementById('nuevo-motivo').value = '';
            document.getElementById('nuevo-usuario').value = '';
            document.getElementById('nuevo-password').value = '';
        }
        
        async function crearPaciente() {
            const nombre = document.getElementById('nuevo-nombre').value.trim();
            const fecha = document.getElementById('nuevo-fecha').value;
            const motivo = document.getElementById('nuevo-motivo').value.trim();
            const usuario = document.getElementById('nuevo-usuario').value.trim();
            const password = document.getElementById('nuevo-password').value;
            
            if (!nombre) return mostrarMensaje('Ingrese el nombre', 'error');
            if (!usuario || !password) return mostrarMensaje('Ingrese usuario y contrase√±a', 'error');
            if (password.length < 6) return mostrarMensaje('Contrase√±a m√≠nimo 6 caracteres', 'error');
            
            const existe = await db.collection('pacientes').where('credenciales.usuario', '==', usuario).get();
            if (!existe.empty) return mostrarMensaje('El usuario ya existe', 'error');
            
            document.getElementById('btn-crear-paciente').disabled = true;
            mostrarLoading('Creando...');
            
            const nuevo = { nombre, fechaInicio: fecha, motivo, fechaCreacion: new Date().toISOString(), credenciales: { usuario, password }, plan: crearPlanVacio() };
            if (await guardarPaciente(nuevo)) {
                pacientes.unshift(nuevo);
                cerrarModal();
                renderizarLista();
                mostrarMensaje('Paciente creado');
            }
            document.getElementById('btn-crear-paciente').disabled = false;
            ocultarLoading();
        }
        
        function crearPlanVacio() {
            return {
                fases: {
                    1: { objetivo: 'Eliminar toxinas y limpiar el sistema digestivo, h√≠gado, ri√±ones y piel.', duracion: 60, fechaInicio: '', fechaFin: '', estado: 'Pendiente', observaciones: '', resultado: '', hierbas: [{ nombre: '', dosis: '', frecuencia: '' }, { nombre: '', dosis: '', frecuencia: '' }] },
                    2: { objetivo: 'Reducir la inflamaci√≥n sist√©mica para mejorar el funcionamiento del organismo.', duracion: 120, fechaInicio: '', fechaFin: '', estado: 'Pendiente', observaciones: '', resultado: '', hierbas: [{ nombre: '', dosis: '', frecuencia: '' }, { nombre: '', dosis: '', frecuencia: '' }] },
                    3: { objetivo: 'Reforzar √≥rganos y sistemas, mejorar el metabolismo y aumentar la energ√≠a.', duracion: 90, fechaInicio: '', fechaFin: '', estado: 'Pendiente', observaciones: '', resultado: '', hierbas: [{ nombre: '', dosis: '', frecuencia: '' }, { nombre: '', dosis: '', frecuencia: '' }] },
                    4: { objetivo: 'Abordar s√≠ntomas particulares con plantas espec√≠ficas seg√∫n el caso.', duracion: 90, fechaInicio: '', fechaFin: '', estado: 'Pendiente', observaciones: '', resultado: '', hierbas: [{ nombre: '', dosis: '', frecuencia: '' }, { nombre: '', dosis: '', frecuencia: '' }] }
                },
                fasesCompletadas: [],
                recomendaciones: ['Beber abundante agua.', 'Alimentaci√≥n natural.', 'Cenar temprano.', 'Evitar ultraprocesados.', 'Ejercicio moderado.'],
                profesional: '', telefono: '', proximaCita: '', horaCita: ''
            };
        }
        
        function prepararEliminar(id) {
            pacienteAEliminar = id;
            document.getElementById('nombre-eliminar').textContent = pacientes.find(p => p.id === id).nombre;
            document.getElementById('modal-eliminar').classList.add('visible');
        }
        
        function cerrarModalEliminar() { document.getElementById('modal-eliminar').classList.remove('visible'); pacienteAEliminar = null; }
        
        async function confirmarEliminar() {
            if (pacienteAEliminar) {
                mostrarLoading('Eliminando...');
                if (await eliminarPacienteDB(pacienteAEliminar)) {
                    pacientes = pacientes.filter(p => p.id !== pacienteAEliminar);
                    cerrarModalEliminar();
                    renderizarLista();
                    mostrarMensaje('Eliminado');
                }
                ocultarLoading();
            }
        }
        
        function verCredenciales(id, e) {
            e.stopPropagation();
            const p = pacientes.find(x => x.id === id);
            if (p?.credenciales) {
                document.getElementById('cred-usuario').textContent = p.credenciales.usuario;
                document.getElementById('cred-password').textContent = p.credenciales.password;
                document.getElementById('modal-credenciales').classList.add('visible');
            }
        }
        
        function cerrarModalCredenciales() { document.getElementById('modal-credenciales').classList.remove('visible'); }
        
        function calcularProgresoGeneral(p) { let t = 0; for (let i = 1; i <= 4; i++) t += calcularPorcentajeFase(p.plan.fases[i]); return Math.round(t / 4); }
        
        function calcularPorcentajeFase(f) {
            if (!f.fechaInicio || !f.duracion) return 0;
            const dias = Math.floor((new Date() - new Date(f.fechaInicio)) / 86400000);
            if (dias < 0) return 0;
            if (dias >= f.duracion) return 100;
            return Math.round((dias / f.duracion) * 100);
        }
        
        function renderizarLista() {
            const grid = document.getElementById('pacientes-grid');
            const vacio = document.getElementById('estado-vacio');
            document.getElementById('total-pacientes').textContent = pacientes.length;
            document.getElementById('en-tratamiento').textContent = pacientes.filter(p => { const pr = calcularProgresoGeneral(p); return pr > 0 && pr < 100; }).length;
            
            if (!pacientes.length) { grid.innerHTML = ''; vacio.style.display = 'block'; return; }
            vacio.style.display = 'none';
            
            grid.innerHTML = pacientes.map(p => {
                const prog = calcularProgresoGeneral(p);
                const fases = [1,2,3,4].map(i => { const pct = calcularPorcentajeFase(p.plan.fases[i]); return `<div class="fase-indicador ${pct >= 100 ? 'completada' : pct > 0 ? 'activa' : ''}"></div>`; }).join('');
                return `<div class="paciente-card" onclick="abrirPaciente('${p.id}')">
                    <div class="paciente-header">
                        <div class="paciente-nombre">${p.nombre}</div>
                        <div class="paciente-fecha">Inicio: ${p.fechaInicio ? new Date(p.fechaInicio).toLocaleDateString('es-AR') : 'No especificada'}</div>
                        <div class="paciente-credenciales" onclick="verCredenciales('${p.id}', event)">üîê Credenciales</div>
                    </div>
                    <div class="paciente-body">
                        <div class="paciente-motivo">${p.motivo || 'Sin motivo'}</div>
                        <div class="paciente-progreso"><div class="progreso-label"><span>Progreso</span><span>${prog}%</span></div><div class="progreso-barra"><div class="progreso-fill" style="width:${prog}%"></div></div></div>
                        <div class="paciente-fases">${fases}</div>
                        <div class="paciente-acciones" onclick="event.stopPropagation()">
                            <button class="btn-accion btn-abrir" onclick="abrirPaciente('${p.id}')">Abrir Plan</button>
                            <button class="btn-accion btn-eliminar" onclick="prepararEliminar('${p.id}')">Eliminar</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }
        
        function filtrarPacientes() {
            const q = document.getElementById('busqueda').value.toLowerCase();
            document.querySelectorAll('.paciente-card').forEach(c => {
                const n = c.querySelector('.paciente-nombre').textContent.toLowerCase();
                c.style.display = n.includes(q) ? 'block' : 'none';
            });
        }
        
        async function abrirPaciente(id) {
            pacienteActual = pacientes.find(p => p.id === id);
            if (!pacienteActual) return;
            document.getElementById('vista-lista').classList.add('oculta');
            document.getElementById('vista-plan').classList.add('visible');
            document.getElementById('btn-volver').style.display = 'flex';
            renderizarPlan(false);
        }
        
        async function volverALista() {
            await guardarPlanActual();
            document.getElementById('vista-lista').classList.remove('oculta');
            document.getElementById('vista-plan').classList.remove('visible');
            pacienteActual = null;
            await cargarPacientes();
            renderizarLista();
        }
        
        function renderizarPlan(modoLectura = false) {
            const container = document.getElementById('plan-container');
            const p = pacienteActual, plan = p.plan;
            container.className = `plan-container ${modoLectura ? 'modo-lectura' : ''}`;
            const badge = modoLectura ? '<span class="badge-lectura">Solo lectura</span>' : '';
            
            container.innerHTML = `
                <div class="plan-header"><h1>PLAN DE TRATAMIENTO HERBAL ${badge}</h1><p>${p.nombre}</p></div>
                <div class="datos-paciente">
                    <h2>Datos del Paciente</h2>
                    <div class="campo"><label>Nombre</label><input value="${p.nombre}" ${modoLectura ? 'readonly' : 'onchange="actualizarDato(\'nombre\', this.value)"'}></div>
                    <div class="campo"><label>Fecha inicio</label><input type="date" value="${p.fechaInicio || ''}" ${modoLectura ? 'readonly' : 'onchange="actualizarDato(\'fechaInicio\', this.value)"'}></div>
                    <div class="campo"><label>Motivo</label><textarea rows="2" ${modoLectura ? 'readonly' : 'onchange="actualizarDato(\'motivo\', this.value)"'}>${p.motivo || ''}</textarea></div>
                </div>
                <div class="progreso-section">
                    <h3>PROGRESO DEL TRATAMIENTO</h3>
                    <div class="progreso-barra-main">
                        ${[1,2,3,4].map(i => {
                            const comp = plan.fasesCompletadas.includes(i.toString());
                            const pct = calcularPorcentajeFase(plan.fases[i]);
                            return `<div class="progreso-item ${comp ? 'completado' : ''}" ${modoLectura ? '' : `onclick="toggleFase(${i})"`}><span>${comp ? '‚úì' : '‚òê'} Fase ${i}</span><small>${['Purga','Desinflamaci√≥n','Fortalecimiento','Espec√≠fico'][i-1]}</small><div class="porcentaje-mini">${pct}%</div></div>${i < 4 ? '<span class="flecha">‚Üí</span>' : ''}`;
                        }).join('')}
                    </div>
                </div>
                ${renderizarFases(plan, modoLectura)}
                <div class="recomendaciones">
                    <h3>Recomendaciones</h3>
                    <div class="recomendaciones-container">${plan.recomendaciones.map((r, i) => `<div class="recomendacion-row"><span class="recomendacion-bullet">‚Ä¢</span><input value="${r}" ${modoLectura ? 'readonly' : `onchange="actualizarRec(${i}, this.value)"`}><button class="btn-eliminar-small" onclick="eliminarRec(${i})">√ó</button></div>`).join('')}</div>
                    <button class="btn-agregar" onclick="agregarRec()">+ Agregar</button>
                </div>
                <div class="contacto">
                    <h3>Contacto</h3>
                    <div class="campo"><label>Profesional</label><input value="${plan.profesional || ''}" ${modoLectura ? 'readonly' : 'onchange="actualizarContacto(\'profesional\', this.value)"'}></div>
                    <div class="campo"><label>Tel√©fono</label><input value="${plan.telefono || ''}" ${modoLectura ? 'readonly' : 'onchange="actualizarContacto(\'telefono\', this.value)"'}></div>
                    <div class="campo"><label>Pr√≥xima cita</label><input type="date" value="${plan.proximaCita || ''}" ${modoLectura ? 'readonly' : 'onchange="actualizarContacto(\'proximaCita\', this.value)"'}></div>
                    <div class="campo"><label>Hora</label><input type="time" value="${plan.horaCita || ''}" ${modoLectura ? 'readonly' : 'onchange="actualizarContacto(\'horaCita\', this.value)"'}></div>
                </div>
                <div class="botones-plan">
                    <button class="btn-plan btn-guardar-plan" onclick="guardarYMostrar()">Guardar</button>
                    <button class="btn-plan btn-imprimir" onclick="window.print()">Imprimir</button>
                </div>
            `;
            for (let i = 1; i <= 4; i++) actualizarPorcentajeUI(i);
        }
        
        function renderizarFases(plan, modoLectura) {
            const nombres = ['PURGA', 'DESINFLAMACI√ìN', 'FORTALECIMIENTO', 'TRATAMIENTO ESPEC√çFICO'];
            return [1,2,3,4].map(i => {
                const f = plan.fases[i], pct = calcularPorcentajeFase(f);
                let badge = pct === 0 ? 'no-iniciado' : pct >= 100 ? 'completado' : 'en-progreso';
                return `<div class="acordeon fase-${i}">
                    <div class="acordeon-header" onclick="toggleAcordeon(this)">
                        <div class="acordeon-header-left"><h3>FASE ${i}: ${nombres[i-1]}</h3><span class="porcentaje-badge ${badge}" id="badge-${i}">${pct}%</span></div>
                        <span class="icono">+</span>
                    </div>
                    <div class="acordeon-contenido"><div class="acordeon-inner">
                        <div class="progreso-info"><span id="dias-${i}">0 de ${f.duracion} d√≠as</span><span id="pct-${i}">${pct}%</span></div>
                        <div class="progreso-visual"><div class="progreso-visual-fill" id="barra-${i}" style="width:${pct}%"></div></div>
                        <div class="objetivo"><strong>Objetivo:</strong><textarea ${modoLectura ? 'readonly' : `onchange="actualizarFase(${i}, 'objetivo', this.value)"`}>${f.objetivo}</textarea></div>
                        <div class="fase-info">
                            <div><label>Duraci√≥n (d√≠as)</label><input type="number" value="${f.duracion}" ${modoLectura ? 'readonly' : `onchange="actualizarFase(${i}, 'duracion', this.value); actualizarPorcentajeUI(${i})"`}></div>
                            <div><label>Fecha inicio</label><input type="date" id="fi-${i}" value="${f.fechaInicio}" ${modoLectura ? 'readonly' : `onchange="actualizarFase(${i}, 'fechaInicio', this.value); actualizarPorcentajeUI(${i})"`}></div>
                            <div><label>Fecha fin</label><input type="date" id="ff-${i}" value="${f.fechaFin}" ${modoLectura ? 'readonly' : ''}></div>
                            <div><label>Estado</label><input value="${f.estado}" ${modoLectura ? 'readonly' : `onchange="actualizarFase(${i}, 'estado', this.value)"`}></div>
                        </div>
                        <p class="hierbas-titulo">Hierbas:</p>
                        <div class="hierbas-container" id="hierbas-${i}">${f.hierbas.map((h, j) => `<div class="hierba-row"><input placeholder="Nombre" value="${h.nombre}" ${modoLectura ? 'readonly' : `onchange="actualizarHierba(${i}, ${j}, 'nombre', this.value)"`}><input placeholder="Dosis" value="${h.dosis}" ${modoLectura ? 'readonly' : `onchange="actualizarHierba(${i}, ${j}, 'dosis', this.value)"`}><input placeholder="Frecuencia" value="${h.frecuencia}" ${modoLectura ? 'readonly' : `onchange="actualizarHierba(${i}, ${j}, 'frecuencia', this.value)"`}><button class="btn-eliminar-small" onclick="eliminarHierba(${i}, ${j})">√ó</button></div>`).join('')}</div>
                        <button class="btn-agregar" onclick="agregarHierba(${i})">+ Agregar hierba</button>
                        <div class="seccion-extra"><label>Observaciones</label><textarea ${modoLectura ? 'readonly' : `onchange="actualizarFase(${i}, 'observaciones', this.value)"`}>${f.observaciones}</textarea></div>
                        <div class="seccion-extra"><label>Resultado</label><textarea ${modoLectura ? 'readonly' : `onchange="actualizarFase(${i}, 'resultado', this.value)"`}>${f.resultado}</textarea></div>
                    </div></div>
                </div>`;
            }).join('');
        }
        
        function toggleAcordeon(h) { h.parentElement.classList.toggle('abierto'); }
        function toggleFase(i) { const arr = pacienteActual.plan.fasesCompletadas, idx = arr.indexOf(i.toString()); idx >= 0 ? arr.splice(idx, 1) : arr.push(i.toString()); renderizarPlan(false); }
        function actualizarDato(k, v) { pacienteActual[k] = v; }
        function actualizarFase(i, k, v) { if (k === 'duracion') v = parseInt(v) || 0; pacienteActual.plan.fases[i][k] = v; }
        function actualizarHierba(i, j, k, v) { pacienteActual.plan.fases[i].hierbas[j][k] = v; }
        function agregarHierba(i) { pacienteActual.plan.fases[i].hierbas.push({ nombre: '', dosis: '', frecuencia: '' }); renderizarPlan(false); }
        function eliminarHierba(i, j) { if (pacienteActual.plan.fases[i].hierbas.length > 1) { pacienteActual.plan.fases[i].hierbas.splice(j, 1); renderizarPlan(false); } }
        function actualizarRec(i, v) { pacienteActual.plan.recomendaciones[i] = v; }
        function agregarRec() { pacienteActual.plan.recomendaciones.push(''); renderizarPlan(false); }
        function eliminarRec(i) { if (pacienteActual.plan.recomendaciones.length > 1) { pacienteActual.plan.recomendaciones.splice(i, 1); renderizarPlan(false); } }
        function actualizarContacto(k, v) { pacienteActual.plan[k] = v; }
        
        function actualizarPorcentajeUI(i) {
            const f = pacienteActual.plan.fases[i], pct = calcularPorcentajeFase(f);
            const badge = document.getElementById(`badge-${i}`);
            if (badge) { badge.textContent = `${pct}%`; badge.className = 'porcentaje-badge ' + (pct === 0 ? 'no-iniciado' : pct >= 100 ? 'completado' : 'en-progreso'); }
            const barra = document.getElementById(`barra-${i}`);
            if (barra) barra.style.width = `${pct}%`;
            if (f.fechaInicio && f.duracion) {
                let dias = Math.floor((new Date() - new Date(f.fechaInicio)) / 86400000);
                if (dias < 0) dias = 0; if (dias > f.duracion) dias = f.duracion;
                const diasEl = document.getElementById(`dias-${i}`);
                if (diasEl) diasEl.textContent = `${dias} de ${f.duracion} d√≠as`;
                const fin = new Date(f.fechaInicio); fin.setDate(fin.getDate() + parseInt(f.duracion));
                const ffEl = document.getElementById(`ff-${i}`);
                if (ffEl) ffEl.value = fin.toISOString().split('T')[0];
                f.fechaFin = fin.toISOString().split('T')[0];
            }
            const pctEl = document.getElementById(`pct-${i}`);
            if (pctEl) pctEl.textContent = `${pct}%`;
        }
        
        async function guardarPlanActual() {
            if (!pacienteActual) return;
            mostrarLoading('Guardando...');
            await guardarPaciente(pacienteActual);
            const idx = pacientes.findIndex(p => p.id === pacienteActual.id);
            if (idx >= 0) pacientes[idx] = pacienteActual;
            ocultarLoading();
        }
        
        async function guardarYMostrar() { await guardarPlanActual(); mostrarMensaje('Guardado en la nube ‚òÅÔ∏è'); }
    </script>
</body>
</html>
